@inject IJSRuntime JS
@inject IDialogService DialogService
@inject MudLogAnalyzer.Client.Services.IThemeService ThemeService
@implements IDisposable

<div style="display: flex; flex-direction: column; height: 100%;">
    <div style="height: 48px; min-height: 48px; background: @_searchBarBg; display: flex; align-items: center; padding: 0 12px;">
        <MudTextField @bind-Value="_searchText"
                      Placeholder="Search"
                      Variant="Variant.Filled"
                      Margin="Margin.Dense"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      Clearable="true"
                      Style="width: 100%; height: 32px;"
                      Class="nav-search-box" />
    </div>

    <MudNavMenu Style="flex: 1;" Class="custom-nav-menu">
        <MudNavLink Href="" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">Home</MudNavLink>
        <MudNavLink Href="counter" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Add">Counter</MudNavLink>

        <MudNavLink Href="weather" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.List">Weather</MudNavLink>
    </MudNavMenu>

    <div style="padding: 4px; border-top: 1px solid rgba(255, 255, 255, 0.12); display: flex; gap: 4px;">
        <MudIconButton Icon="@(DarkLightModeButtonIcon)" Style="color: white;" OnClick="@DarkModeToggle" Size="Size.Small" />
        <MudIconButton Icon="@Icons.Material.Filled.Palette" Style="color: white;" OnClick="@OpenAppearanceDialog" Size="Size.Small" />
    </div>
</div>

<style>
    .nav-search-box {
        height: 32px !important;
        overflow: hidden !important;
    }

    .nav-search-box .mud-input-control {
        min-height: 32px !important;
        max-height: 32px !important;
        overflow: hidden !important;
    }

    .nav-search-box .mud-input {
        color: white !important;
        font-size: 0.875rem;
        padding-top: 0 !important;
        padding-bottom: 0 !important;
    }

    .nav-search-box .mud-input-root {
        padding-inline-start: 8px;
        min-height: 32px !important;
        max-height: 32px !important;
    }

    .nav-search-box .mud-input-slot {
        max-height: 32px !important;
        overflow: hidden !important;
    }

   /* .nav-search-box .mud-input-outlined .mud-input-root {
        background: rgba(255, 255, 255, 0.1);
    }*/

    .nav-search-box .mud-input-outlined:hover .mud-input-root {
        background: rgba(255, 255, 255, 0.15);
    }

    .nav-search-box .mud-input-adornment svg,
    .nav-search-box .mud-icon-button svg {
        color: rgba(255, 255, 255, 0.7) !important;
        width: 18px;
        height: 18px;
    }

    .nav-search-box .mud-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
    }

    .nav-search-box fieldset {
        border-color: rgba(255, 255, 255, 0.2) !important;
    }

    .nav-search-box:hover fieldset {
        border-color: rgba(255, 255, 255, 0.3) !important;
    }

    .custom-nav-menu {
        border-top-right-radius: 8px !important;
        overflow: hidden;
    }

</style>

@code {
    private string _searchText = "";
    private string _searchBarBg = "#1b1a19";

    [CascadingParameter]
    public bool IsDarkMode { get; set; }

    [Parameter]
    public EventCallback OnDarkModeToggle { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await ThemeService.GetSettingsAsync();
        UpdateSearchBarBackground();
        ThemeService.OnThemeChanged += OnThemeChanged;
    }

    private void OnThemeChanged()
    {
        UpdateSearchBarBackground();
        StateHasChanged();
    }

    private void UpdateSearchBarBackground()
    {
        var theme = ThemeService.GenerateTheme();
        _searchBarBg = theme?.PaletteDark?.DrawerBackground?.ToString() ?? "#1b1a19";
    }

    public void Dispose()
    {
        ThemeService.OnThemeChanged -= OnThemeChanged;
    }

    private async Task DarkModeToggle()
    {
        await OnDarkModeToggle.InvokeAsync();
    }

    public string DarkLightModeButtonIcon => IsDarkMode switch
    {
        true => Icons.Material.Rounded.LightMode,
        false => Icons.Material.Outlined.DarkMode,
    };

    private async Task OpenAppearanceDialog()
    {
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        await DialogService.ShowAsync<MudLogAnalyzer.Client.Components.Appearance>("Appearance", options);
    }
}


